<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pro Pacer V6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000000; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; margin: 0; overflow: hidden; touch-action: manipulation; transition: background-color 0.2s ease; }

        /* --- TOP NAV --- */
        .top-nav { width: 100%; display: flex; justify-content: flex-end; gap: 8px; padding: max(15px, env(safe-area-inset-top)) 15px 5px 15px; z-index: 50; }
        .small-btn { background: rgba(50,50,50,0.8); border: 1px solid #777; padding: 8px 10px; font-size: 0.8rem; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #btn-whatsapp { background-color: #25D366; border-color: #128C7E; font-weight: bold; }
        .sound-on { background-color: #444; color: #fff; }
        .sound-off { background-color: #222; color: #777; text-decoration: line-through; }

        /* --- TIMERS --- */
        #timers-bar { display: flex; justify-content: space-between; width: 94%; padding: 5px 0; color: #555; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid #222; }
        .timer-col { display: flex; flex-direction: column; align-items: center; width: 33%; }
        .timer-val { font-size: 1.1rem; font-weight: bold; margin-top: 2px; font-variant-numeric: tabular-nums; }
        .status-active .timer-val { color: #fff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }
        #skin-val { color: #00ffcc; }

        /* --- BIG DISPLAY --- */
        #last-lap-big { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-size: 25vh; font-weight: bold; letter-spacing: -0.12em; text-shadow: 4px 4px 0px #000; width: 100%; text-align: center; z-index: 10; }
        .pulsing-text { animation: pulse 1s infinite; font-size: 12vh !important; letter-spacing: 0 !important; color: #00ffcc; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- TARGET / SCHEDULE SECTION --- */
        .target-wrapper { width: 94%; z-index: 20; background: rgba(0,0,0,0.5); border-radius: 12px; padding: 10px; margin-bottom: 5px; border: 1px solid #333; }
        .mode-toggle { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .mode-btn { background: #222; border: 1px solid #555; color: #888; padding: 5px 15px; border-radius: 5px; font-size: 0.8rem; width: 48%; }
        .mode-active { background: #0044cc; color: white; border-color: #0066ff; }
        
        .input-area { display: flex; align-items: center; justify-content: center; gap: 10px; }
        label { font-size: 1rem; color: #ddd; text-transform: uppercase; }
        
        /* Static Input */
        #target-input { -webkit-user-select: text; user-select: text; background: #222; border: 1px solid #555; color: #00ffcc; font-size: 1.8rem; width: 100px; text-align: center; border-radius: 8px; font-family: monospace; }
        
        /* Schedule Input */
        #schedule-ui { display: none; width: 100%; }
        #schedule-input { -webkit-user-select: text; user-select: text; width: 100%; height: 80px; background: #222; border: 1px solid #555; color: #fff; font-size: 0.9rem; font-family: monospace; border-radius: 5px; padding: 5px; }
        
        .next-target-display { font-size: 0.8rem; color: #aaa; margin-top: 5px; text-align: center; display: none;}

        /* --- LAP LIST --- */
        #laps-container { height: 15vh; width: 94%; overflow-y: auto; -webkit-overflow-scrolling: touch; text-align: center; font-size: 1rem; border-top: 1px solid #555; margin-bottom: 5px; background: rgba(0,0,0,0.3); z-index: 20; border-radius: 8px; }
        
        /* UPDATED LAP ROW CSS TO FIX BLANK SPACES */
        .lap-row { 
            padding: 8px 12px; 
            border-bottom: 1px solid #333; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .lap-left {
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
        }
        .lap-right {
            font-family: monospace;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0; /* Prevents time from being squashed */
            margin-left: 10px;
        }

        .lap-good { color: #ffffff; font-weight: bold; }
        .lap-bad { color: #000000; font-weight: bold; }
        .target-tag { color: #888; font-size: 0.8rem; margin-left: 5px; font-weight: normal;}

        /* --- CONTROLS --- */
        .controls { display: flex; width: 100%; height: 20vh; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 1000; }
        button { border: none; color: white; font-size: 1.5rem; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        button:active { opacity: 0.8; }
        
        #btn-stop { 
            width: 30%; 
            background-color: #cc0000; 
            border-right: 2px solid black; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            line-height: 1.1;
        }
        .stop-small { font-size: 1rem; font-weight: normal; opacity: 0.8; }
        .stop-big { font-size: 2.5rem; font-weight: bold; }

        #btn-lap { width: 70%; background-color: #0044cc; font-size: 3rem; }
        
        .footer-credit { font-size: 0.7rem; color: #666; margin-bottom: 5px; z-index: 10; }

        /* --- MODALS --- */
        #qr-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        #qr-modal canvas { border: 15px solid white; border-radius: 5px; width: 80vw; max-width: 350px; }
        #btn-copy { background: #0044cc; color: white; border: 2px solid white; padding: 15px 30px; border-radius: 10px; font-size: 1.2rem; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="qr-modal">
        <canvas id="qr-code"></canvas>
        <button id="btn-copy">ðŸ“‹ Copy Link</button>
        <div id="close-text" style="color:#aaa; text-decoration:underline;" onclick="document.getElementById('qr-modal').style.display='none'">Close X</div>
    </div>

    <div class="top-nav">
        <button id="btn-sound" class="small-btn sound-off">ðŸ”‡</button>
        <button id="btn-qr" class="small-btn">QR ðŸ“±</button>
        <button id="btn-whatsapp" class="small-btn">Share ðŸ’¬</button>
        <button id="btn-reset" class="small-btn">RESET</button>
    </div>

    <div id="timers-bar">
        <div class="timer-col"><span class="timer-label">Total</span><span id="total-val" class="timer-val">00:00.0</span></div>
        <div class="timer-col"><span class="timer-label">Lap</span><span id="lap-val" class="timer-val">00:00.0</span></div>
        <div class="timer-col"><span class="timer-label">Skin</span><span id="skin-val" class="timer-val">0.0</span></div>
    </div>

    <div id="last-lap-big" class="pulsing-text">READY</div>

    <div class="target-wrapper">
        <div class="mode-toggle">
            <button id="mode-static" class="mode-btn mode-active">Static Target</button>
            <button id="mode-schedule" class="mode-btn">Race Schedule</button>
        </div>

        <div id="static-ui" class="input-area">
            <label>Target:</label>
            <input type="number" id="target-input" value="15.0" step="0.1">
        </div>

        <div id="schedule-ui">
            <textarea id="schedule-input" placeholder="Paste times here...&#10;15.5&#10;15.2&#10;15.0"></textarea>
            <div id="next-lap-display" class="next-target-display">Next Lap Target: --</div>
        </div>
    </div>

    <div id="laps-container"><div id="laps-list"></div></div>
    <div class="footer-credit">Recorded by www.MakeMeFaster.com</div>

    <div class="controls">
        <button id="btn-stop">
            <div class="stop-small">STOP</div>
            <div id="stop-countdown" class="stop-big"></div>
        </button>
        <button id="btn-lap">START</button>
    </div>

    <script>
        // --- VARIABLES ---
        let startTime = 0; let accumulatedTime = 0; let timerInterval; let running = false;
        let sessionData = []; 
        let totalTimeElapsed = 0; let lapTimeElapsed = 0; let lastTick = 0;
        let soundEnabled = false; 
        
        // SCHEDULE LOGIC
        let isScheduleMode = false;
        let scheduleTargets = []; 
        let currentLapIndex = 0; 

        // --- ELEMENTS ---
        const totalDisplay = document.getElementById("total-val");
        const lapDisplay = document.getElementById("lap-val");
        const skinDisplay = document.getElementById("skin-val");
        const lastLapBigDisplay = document.getElementById("last-lap-big");
        const lapBtn = document.getElementById("btn-lap");
        const stopBtn = document.getElementById("btn-stop");
        const stopCountdown = document.getElementById("stop-countdown");
        const lapsList = document.getElementById("laps-list");
        const targetInput = document.getElementById("target-input");
        
        const btnStatic = document.getElementById("mode-static");
        const btnSchedule = document.getElementById("mode-schedule");
        const staticUI = document.getElementById("static-ui");
        const scheduleUI = document.getElementById("schedule-ui");
        const scheduleInput = document.getElementById("schedule-input");
        const nextLapDisplay = document.getElementById("next-lap-display");

        // --- BUTTON LISTENERS ---
        lapBtn.addEventListener('click', () => {
            if(running && isScheduleMode && getRemainingLaps() === 1) {
                stopTimer();
            } else {
                lapOrStart();
            }
        });

        stopBtn.addEventListener('click', stopTimer);
        document.getElementById("btn-qr").addEventListener('click', showQR);
        document.getElementById("btn-whatsapp").addEventListener('click', shareToWhatsapp);
        document.getElementById("btn-reset").addEventListener('click', resetAll);
        document.getElementById("btn-copy").addEventListener('click', copyToClipboard);
        document.getElementById("btn-sound").addEventListener('click', toggleSound);

        // --- MODE SWITCHING ---
        btnStatic.addEventListener('click', () => setMode(false));
        btnSchedule.addEventListener('click', () => setMode(true));

        function setMode(isSchedule) {
            isScheduleMode = isSchedule;
            if (isSchedule) {
                btnSchedule.classList.add("mode-active");
                btnStatic.classList.remove("mode-active");
                scheduleUI.style.display = "block";
                staticUI.style.display = "none";
            } else {
                btnStatic.classList.add("mode-active");
                btnSchedule.classList.remove("mode-active");
                staticUI.style.display = "flex";
                scheduleUI.style.display = "none";
            }
        }

        // --- KEYBOARD LISTENER ---
        document.addEventListener('keydown', function(event) {
            if(["PageDown", "PageUp", "ArrowRight", "ArrowLeft", " "].indexOf(event.code) > -1) event.preventDefault();
            
            if (event.key === "PageDown" || event.key === "ArrowRight" || event.key === " ") {
                 if(running && isScheduleMode && getRemainingLaps() === 1) {
                    stopTimer();
                 } else {
                    lapOrStart();
                 }
            }

            if (event.key === "PageUp" || event.key === "ArrowLeft") {
                stopTimer();
            }
        });

        // --- TIMER FUNCTIONS ---
        function tick() {
            const now = Date.now();
            const delta = now - lastTick;
            lastTick = now;
            totalTimeElapsed += delta;
            lapTimeElapsed += delta;
            totalDisplay.innerText = formatFullTime(totalTimeElapsed);
            lapDisplay.innerText = formatFullTime(lapTimeElapsed);
            
            let totalSeconds = Math.floor(lapTimeElapsed / 1000);
            let secondsDigit = totalSeconds % 10;
            let tenthsDigit = Math.floor((lapTimeElapsed % 1000) / 100);
            skinDisplay.innerText = secondsDigit + "." + tenthsDigit;
        }

        function lapOrStart() {
            if (!running) {
                // START
                running = true;
                
                if (isScheduleMode) {
                    parseSchedule();
                    currentLapIndex = 0;
                    updateNextLapDisplay();
                    scheduleInput.style.display = "none"; 
                    nextLapDisplay.style.display = "block";
                    updateStopButtonCount();
                } else {
                    stopCountdown.innerText = "";
                }

                lastTick = Date.now();
                timerInterval = setInterval(tick, 30);
                lapBtn.innerText = "LAP";
                lapBtn.style.backgroundColor = "#0044cc";
                document.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
                document.getElementById("timers-bar").classList.add("status-active");
                
                if (soundEnabled) { let warmUp = new SpeechSynthesisUtterance(""); window.speechSynthesis.speak(warmUp); }
                
                if(totalTimeElapsed === 0) {
                    document.body.style.backgroundColor = "#000000";
                    lastLapBigDisplay.innerText = "GO!";
                    lastLapBigDisplay.classList.add("pulsing-text");
                    sessionData = [];
                }
            } else {
                handleLap();
            }
        }

        function handleLap() {
            lastLapBigDisplay.classList.remove("pulsing-text");
            let finalLapTimeMs = lapTimeElapsed;
            let finalLapStr = formatFullTime(finalLapTimeMs);
            let skinStr = skinDisplay.innerText;
            let skinValNum = parseFloat(skinStr);

            let currentTarget = 0;
            if (!isScheduleMode) {
                currentTarget = parseFloat(targetInput.value);
            } else {
                let indexToUse = currentLapIndex < scheduleTargets.length ? currentLapIndex : scheduleTargets.length - 1;
                currentTarget = scheduleTargets[indexToUse];
            }

            lastLapBigDisplay.innerText = skinStr;
            if (soundEnabled) speakText(skinStr);

            let isGood = skinValNum <= currentTarget;
            document.body.style.backgroundColor = isGood ? "#00aa55" : "#dd2222";

            let lapNum = sessionData.length + 1;
            sessionData.push({ num: lapNum, time: finalLapStr, skin: skinStr, target: currentTarget, status: isGood ? "âœ…" : "âŒ" });

            // HTML CONSTRUCTION FOR LAP ROW
            let row = document.createElement("div");
            row.className = "lap-row " + (isGood ? "lap-good" : "lap-bad");
            let cleanTime = removeLeadingZeros(finalLapStr);
            row.innerHTML = `
                <div class="lap-left">#${lapNum} <small class="target-tag">[Target: ${currentTarget}]</small></div>
                <div class="lap-right">${cleanTime}</div>
            `;
            lapsList.prepend(row);

            // Reset Lap
            lapTimeElapsed = 0;
            lapDisplay.innerText = "00:00.00";
            skinDisplay.innerText = "0.0";

            if (isScheduleMode) {
                currentLapIndex++;
                updateNextLapDisplay();
                updateStopButtonCount();
            }
        }

        function parseSchedule() {
            let raw = scheduleInput.value;
            let parts = raw.split(/[\n, ]+/).filter(p => p.trim() !== "");
            scheduleTargets = parts.map(p => parseFloat(p));
            if (scheduleTargets.length === 0) scheduleTargets = [15.0];
        }

        function getRemainingLaps() {
            if(!isScheduleMode) return 999;
            let remaining = scheduleTargets.length - currentLapIndex;
            return remaining < 0 ? 0 : remaining;
        }

        function updateNextLapDisplay() {
            let nextIndex = currentLapIndex; 
            let displayIndex = nextIndex < scheduleTargets.length ? nextIndex : scheduleTargets.length - 1;
            let val = scheduleTargets[displayIndex];
            nextLapDisplay.innerText = "Current Lap Target: " + val + "s";
        }

        function updateStopButtonCount() {
            if(isScheduleMode && scheduleTargets.length > 0) {
                let remaining = getRemainingLaps();
                stopCountdown.innerText = remaining;
                
                if (remaining === 1) {
                    lapBtn.innerText = "FINISH";
                    lapBtn.style.backgroundColor = "#cc0000";
                } else {
                    lapBtn.innerText = "LAP";
                    lapBtn.style.backgroundColor = "#0044cc";
                }
            } else {
                stopCountdown.innerText = "";
            }
        }

        function stopTimer() {
            if (running) {
                if (lapTimeElapsed > 100) handleLap();
                running = false;
                clearInterval(timerInterval);
                document.body.style.backgroundColor = "#000000";

                lapBtn.innerText = "RESUME";
                lapBtn.style.backgroundColor = "#00aa55";
                
                document.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
                document.getElementById("timers-bar").classList.remove("status-active");
                lastLapBigDisplay.classList.remove("pulsing-text");
                
                if(isScheduleMode) {
                    scheduleInput.style.display = "block";
                    nextLapDisplay.style.display = "none";
                }
            }
        }

        function resetAll() {
            stopTimer();
            document.body.style.backgroundColor = "#000000";
            totalTimeElapsed = 0; lapTimeElapsed = 0;
            totalDisplay.innerText = "00:00.00"; lapDisplay.innerText = "00:00.00"; skinDisplay.innerText = "0.0";
            lastLapBigDisplay.innerText = "READY"; lastLapBigDisplay.classList.add("pulsing-text");
            lapsList.innerHTML = ""; lapBtn.innerText = "START"; lapBtn.style.backgroundColor = "#0044cc";
            sessionData = []; currentLapIndex = 0;
            stopCountdown.innerText = "";
            document.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
        }

        // --- UTILS ---
        function formatFullTime(ms) {
            let date = new Date(ms);
            return date.getUTCMinutes().toString().padStart(2,'0') + ":" + 
                   date.getUTCSeconds().toString().padStart(2,'0') + "." + 
                   Math.floor(date.getUTCMilliseconds()/10).toString().padStart(2,'0');
        }

        function removeLeadingZeros(timeStr) {
            if(!timeStr) return "0.0";
            if(timeStr.startsWith("00:")) {
                let s = timeStr.substring(3);
                if(s.startsWith("0")) return s.substring(1);
                return s;
            }
            if(timeStr.startsWith("0")) return timeStr.substring(1);
            return timeStr;
        }
        
        function speakText(text) {
            window.speechSynthesis.cancel();
            let msg = new SpeechSynthesisUtterance(text.replace(".", " "));
            msg.rate = 1.4; 
            msg.pitch = 1.0; 
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            let btn = document.getElementById("btn-sound");
            if(soundEnabled) { btn.innerHTML = "ðŸ”Š"; btn.className = "small-btn sound-on"; speakText("Voice On"); }
            else { btn.innerHTML = "ðŸ”‡"; btn.className = "small-btn sound-off"; window.speechSynthesis.cancel(); }
        }

        // --- SHARE & EXPORT ---
        function buildExportText() {
            if (sessionData.length === 0) return "No Data";
            let now = new Date();
            let dateStr = now.toLocaleDateString() + " " + now.toLocaleTimeString();
            
            let txt = `PACER SESSION REPORT\n`;
            txt += `Date: ${dateStr}\n`;
            txt += `--------------------------\n`;
            
            sessionData.forEach(lap => {
                let cleanTime = removeLeadingZeros(lap.time);
                txt += `Lap ${lap.num}: ${cleanTime} (Target: ${lap.target}) ${lap.status}\n`;
            });
            
            txt += `--------------------------\n`;
            txt += `Total: ${totalDisplay.innerText}\n`;
            txt += `Recorded by www.MakeMeFaster.com`;
            return txt;
        }

        function copyToClipboard() {
            let text = buildExportText();
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => alert("âœ… Copied Report!")).catch(err => manualCopy(text));
            } else { manualCopy(text); }
        }
        
        function manualCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta); ta.focus(); ta.select();
            try { document.execCommand('copy'); alert("âœ… Copied Report!"); } catch (e) { alert("Failed to copy"); }
            document.body.removeChild(ta);
        }

        function shareToWhatsapp() {
            if (sessionData.length === 0) { alert("No data!"); return; }
            window.open("https://wa.me/?text=" + encodeURIComponent(buildExportText()), "_blank");
        }

        function showQR() {
            if (sessionData.length === 0) { alert("No data!"); return; }
            var qr = new QRious({ element: document.getElementById('qr-code'), value: "https://wa.me/?text=" + encodeURIComponent(buildExportText()), size: 500 });
            document.getElementById("qr-modal").style.display = "flex";
        }
    </script>
</body>
</html>
